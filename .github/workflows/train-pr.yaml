name: Train & Evaluate (PR)

on:
  pull_request:
    paths:
      - "WMS/src/**"
      - "WMS/configs/**"
      - "dvc.lock"

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::036136800740:role/github-actions-role
          aws-region: eu-central-1

      - name: Pull DVC data
        run: python -m dvc pull

      - name: Train with retry
        run: python devops/scripts/train-with-retry.py --config WMS/configs/train.yaml --max-retries 3
        env:
          MLFLOW_TRACKING_URI: sqlite:///mlruns.db
          MLFLOW_ARTIFACT_ROOT: s3://wms-mlflow-artifacts-036136800740/ci-runs/

      - name: Upload MLflow run data to S3
        if: always()
        run: |
          if [ -d mlruns/ ]; then
            aws s3 sync mlruns/ s3://wms-mlflow-artifacts-036136800740/ci-runs/
          fi

      - name: Post results as PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('training-report.json')) {
              const report = JSON.parse(fs.readFileSync('training-report.json', 'utf8'));
              const status = report.status === 'PASS' ? '✅ PASS' : '❌ FAIL';
              const attempts = report.attempts || [];
              let body = `## Training Results: ${status}\n\n`;
              body += `**Started:** ${report.started_at}\n\n`;
              body += `### Attempts\n\n`;
              for (const att of attempts) {
                const metrics = att.metrics || {};
                body += `**Attempt ${att.attempt}** (seed ${att.seed}): `;
                body += `Dice ${metrics.val_dice?.toFixed(4) || 'N/A'}, `;
                body += `IoU ${metrics.val_iou?.toFixed(4) || 'N/A'}\n`;
              }
              if (report.best_attempt) {
                body += `\n**Best attempt:** ${report.best_attempt}`;
              }
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }
