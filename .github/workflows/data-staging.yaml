name: Data Staging ‚Üí Branch

# This workflow handles the "magic branch" approach
# User can push to data/staging, and it automatically creates a timestamped branch

on:
  push:
    branches:
      - 'data/staging'
      - 'data/new'

jobs:
  create-timestamped-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create timestamped data branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH="data/$TIMESTAMP"

          echo "üì¶ Creating timestamped branch: $BRANCH"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create new branch from current staging branch
          git checkout -b "$BRANCH"

          # Push the new branch
          git push origin "$BRANCH"

          echo "‚úÖ Created branch: $BRANCH"
          echo "üóëÔ∏è  Deleting staging branch..."

          # Delete the staging branch
          git push origin --delete "${{ github.ref_name }}"

          echo "‚úÖ Done!"
          echo ""
          echo "The data-upload workflow will now take over on branch: $BRANCH"

      - name: Comment on commit
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 15);
            const newBranch = `data/${timestamp}`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `üöÄ **Data staging processed**

              Your changes have been moved to branch: \`${newBranch}\`

              **Next steps:**
              1. Data validation will run automatically
              2. If data passes QA, a Pull Request will be created
              3. Training pipeline will execute
              4. Results will be commented on the PR

              [View Actions](${context.payload.repository.html_url}/actions)`
            });
